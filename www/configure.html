<!DOCTYPE html>

<html>
<head>
	<meta charset="UTF-8">

	<title>AGS Configuration</title>
	<link rel="Stylesheet" href="res/css/jquery.validity.css" />
	<link rel="Stylesheet" href="res/css/solar.css" />
	<script src="res/js/jquery-1.11.1.min.js"></script>
	<!-- Validity URL http://validity.thatscaptaintoyou.com/Demos/#Introduction -->
	<script src="res/js/jquery.validity.min.js"></script>
</head>

<body>
<div id="wrapper" style="width: 100%; margin-left: auto; margin-right: auto; background-color:#ffffff;">
	

<div>
	<div id = "header" style = "width:100%;">


		<a href="http://www.solarstik.com/"><img src="res/images/logo_s.png" alt="Solar Stik" style = "text-decoration: none; border: none; outline: none; padding-bottom: 5px; padding-top: 30px; padding-left: 5px;" /></a>

		<b style = "padding-left: 20px" >24/7 Support: 800-793-4364 Ext 102</b>




	</div>
	<div class="navBarCon">	
		<ul  style="border: none; width:100%; border-spacing: 0px;list-style-type: none;">


				<li>
					<a  href="/">Current Conditions</a>
				</li>
				<li>
					<a  href="currentSettings.html">Current Settings</a>
				</li>
				<li>
					<a  href="historical.html">Historical Data</a>
				</li>
				<li>
					<a  href="configure.html">Generator Configuration</a>
				</li>
			</ul>
	</div>
				

						
</div>
<div style="text-align: center;">
	<h1 id="headline">Generator Settings</h1>
			<!--Note: This server will be down for scheduled maintenance from 7PM to 9PM CST today.-->
	<br />
</div>	
<form id="agsConfigurationForm">
	<div class="settings_section">
		<div class="section_center">
			<h3>System Voltage</h3>
			<h4>Enable:</h4>
			<input type="radio" name="ags_system_voltage_enable" value="0"> No<br />
			<input type="radio" name="ags_system_voltage_enable" value="1"> Yes

			<h4>Start Voltage:</h4>
			<!-- fixed point with two digits to the left of decimal and one to the right-->
			<input id='ags_system_voltage_start_voltage' type="text" name="ags_system_voltage_start_voltage" title="Start Voltage " placeholder="Format: xx.x"/>
			<h4>Stop Voltage:</h4>
			<!-- fixed point with two digits to the left of decimal and one to the right, and > start voltage -->
			<input id='ags_system_voltage_stop' type="text" name="ags_system_voltage_stop"  title="Stop Voltage" placeholder="Format: xx.x"/>
		</div>
	</div>
	
	<div class="settings_section">
		<div class="section_center">
		<h3>System Time</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_time_enable" value="0"> No<br />
		<input type="radio" name="ags_system_time_enable" value="1"> Yes

		<h4>Start Hour:</h4>

		<!-- integer >= 0 <= 23 -->
		<input type="text" name="ags_system_time_start_hour"  title="Start Hour" placeholder="Number between 0 and 23"/>
		<h4>Duration, minutes:</h4>

		<!-- integer greater > 0, < 1400 -->
		<input type="text" name="ags_system_time_duration_minutes"  title="Duration, minutes" placeholder="Number between 0 and 1400"/>
		</div>
	</div>
	<div class="settings_section">
		<div class="section_center">
		<h3>System SOC</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_soc_enable" value="0"> No<br />
		<input type="radio" name="ags_system_soc_enable" value="1"> Yes

		<h4>Start SOC:</h4>

		<!-- integer > 0 and < 100 -->
		<input type="text" name="ags_system_soc_start_soc"  title="Start SOC" placeholder="Number between 0 and 100"/>
		<h4>Stop SOC:</h4>

		<!-- integer greater than start SOC, <= 100 -->
		<input type="text" name="ags_system_soc_stop_soc"  title="Stop SOC" placeholder="Number between 0 and 100"/>
		</div>
	</div>
	<div class="settings_section">
		<div class="section_center">
		<h3>System amps</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_amps_enable" value="0"> No<br />
		<input type="radio" name="ags_system_amps_enable" value="1"> Yes

		<h4>Start amps:</h4>

		<!-- integer < 0 and > -400 -->
		<input type="text" name="ags_system_amps_start_amps" title="Start Amps" placeholder="Number between -400 and 0"/>
		<h4>Duration, minutes:</h4>

		<!-- integer greater > 0, < 1400 -->
		<input type="text" name="ags_system_amps_duration_minutes" title="Duration, Minutes"  placeholder="Number between 0 and 1400"/>
		</div>
	</div>
	<div class="settings_section">
		<div class="section_center">
		<h3>Transformer Temperature exceeds set point</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_transformer_temperature_enable" value="0"> No<br />
		<input type="radio" name="ags_system_transformer_temperature_enable" value="1"> Yes

		<h4>Start when transformer temperature exceeds:</h4>
		<!-- integer > 10 and < 200 -->

		<input type="text" name="ags_system_transformer_temperature_exceeds" title="Transformer Temperature Exceeds"  placeholder="Number between 10 and 200"/>
		<h4>Duration, minutes:</h4>

		<!-- integer greater > 0, < 1400 -->
		<input type="text" name="ags_system_transformer_duration_minutes" title="Duration, minutes" placeholder="Number between 0 and 1400"/>
		</div>
	</div>
	<div class="settings_section">
		<div class="section_center">
		<h3>Battery Temperature Exceeds Set Point</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_battery_temperature_enable" value="0"> No<br />
		<input type="radio" name="ags_system_battery_temperature_enable" value="1"> Yes

		<h4>Start When Battery Temperature Exceeds:</h4>

		<!-- integer > 10 and < 200 -->
		<input type="text" name="ags_system_battery_temperature_exceeds" title="Battery Temperature Exceeds" placeholder="Number between 10 and 200"/>
		<h4>Duration, Minutes:</h4>

		<!-- integer greater > 0, < 1400 -->
		<input type="text" name="ags_system_battery_duration_minutes" title="Duration, minutes" placeholder="Number between 0 and 1400"/>
		</div>
	</div>
	<div class="settings_section">
		<div class="section_center">
		<h3>Daily Maintenance Schedule</h3>
		<h4>Enable:</h4>
		<input type="radio" name="ags_system_exercise_enable" value="0"> No<br />
		<input type="radio" name="ags_system_exercise_enable" value="1"> Yes

		<h4>Days Between Runs:</h4>

		<!-- integer > 0 <= 30 -->
		<input type="text" name="ags_system_exercise_days_between_runs" title="Days Between Runs" placeholder="Number between 0 and 30"/>
		<h4>Start Hour:</h4>

		<!-- integer >= 0 <= 23 -->
		<input type="text" name="ags_system_exercise_start_hour" title="Start Hour" placeholder="Number between 0 and 23"/>
		<h4>Duration, minutes:</h4>

		<!-- integer greater > 0, < 1400 -->
		<input type="text" name="ags_system_exercise_duration_minutes" title="Duration, Minutes" placeholder="Number between 0 and 1400"/>
		</div>
	</div>
	
	<br />
	<input type="button" id="update" value="Apply Changes" />
</form>
</div>
<script>

var agent = window.navigator.userAgent;
var url = "/data/configuration";
var ie_hack = '.json';
if (agent.search('MSIE') >= 0 || agent.search('Trident') >= 0) {
	ie_hack = '.dat';
}

$.ajax(url + ie_hack, {
	cache: false,
	dataType: 'json',
}).done(function (data, status, XHR) {
	for (p in data) {
		$("input[type=text][name=" + p + "]").val(data[p]);
		$("input[type=radio][name=" + p + "]" + "[value='" + data[p] + "']").prop("checked", true);
	}
}).fail(function (XHR, status, error) {
	alert('There was an error retrieving config data!');
});

//disables sections of the form when the radio button for that section is set to no
function toggleSection(name, value){
	if(name == 'ags_system_voltage_enable'){
		if(value == 1){
			$('input[name="ags_system_voltage_start_voltage"]').removeAttr('disabled');
			$('input[name="ags_system_voltage_stop"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_voltage_start_voltage"]').attr('disabled','disabled');
			$('input[name="ags_system_voltage_stop"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_time_enable'){
		if(value == 1){
			$('input[name="ags_system_time_start_hour"]').removeAttr('disabled');
			$('input[name="ags_system_time_duration_minutes"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_time_start_hour"]').attr('disabled','disabled');
			$('input[name="ags_system_time_duration_minutes"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_amps_enable'){
		if(value == 1){
			$('input[name="ags_system_amps_start_amps"]').removeAttr('disabled');
			$('input[name="ags_system_amps_duration_minutes"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_amps_start_amps"]').attr('disabled','disabled');
			$('input[name="ags_system_amps_duration_minutes"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_soc_enable'){
		if(value == 1){
			$('input[name="ags_system_soc_start_soc"]').removeAttr('disabled');
			$('input[name="ags_system_soc_stop_soc"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_soc_start_soc"]').attr('disabled','disabled');
			$('input[name="ags_system_soc_stop_soc"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_transformer_temperature_enable'){
		if(value == 1){
			$('input[name="ags_system_transformer_temperature_exceeds"]').removeAttr('disabled');
			$('input[name="ags_system_transformer_duration_minutes"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_transformer_temperature_exceeds"]').attr('disabled','disabled');
			$('input[name="ags_system_transformer_duration_minutes"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_battery_temperature_enable'){
		if(value == 1){
			$('input[name="ags_system_battery_temperature_exceeds"]').removeAttr('disabled');
			$('input[name="ags_system_battery_duration_minutes"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_battery_temperature_exceeds"]').attr('disabled','disabled');
			$('input[name="ags_system_battery_duration_minutes"]').attr('disabled','disabled');
		}
	}
	else if(name == 'ags_system_exercise_enable'){
		if(value == 1){
			$('input[name="ags_system_exercise_days_between_runs"]').removeAttr('disabled');
			$('input[name="ags_system_exercise_start_hour"]').removeAttr('disabled');
			$('input[name="ags_system_exercise_duration_minutes"]').removeAttr('disabled');
		}
		else{
			$('input[name="ags_system_exercise_days_between_runs"]').attr('disabled','disabled');
			$('input[name="ags_system_exercise_start_hour"]').attr('disabled','disabled');
			$('input[name="ags_system_exercise_duration_minutes"]').attr('disabled','disabled');
		}
	}
}
	
function validateForms(){
	//variables that will represent values in our form
	var start_voltage, voltage_stop, time_start_hour, time_duration_minutes, start_soc, stop_soc, start_amps, amps_duration_minutes, 
		transformer_temperature_exceeds, transformer_duration_minutes, excercise_days_between_runs, excercise_start_hour, 
		battery_temperature_exceeds, exercise_duration_minutes, battery_duration_minutes,sysVoltageEnabled, sysTimeEnabled, sysSOCEnabled,
		sysAmpsEnabled,transformerTempEnabled, batteryTempEnabled, maintenanceScheduleEnabled;
	
	//decimal format regex
	var reg = /^[0-9]{1,2}\.\d$/;
	var whole = /^-?\d+$/;
	
	//store values from fields into variables
	sysVoltageEnabled = $("input[name='ags_system_voltage_enable']:checked").val();	
	sysTimeEnabled = $("input[name='ags_system_time_enable']:checked").val();	
	sysSOCEnabled = $("input[name='ags_system_soc_enable']:checked").val();	
	sysAmpsEnabled = $("input[name='ags_system_amps_enable']:checked").val();	
	transformerTempEnabled = $("input[name='ags_system_transformer_temperature_enable']:checked").val();
	batteryTempEnabled = $("input[name='ags_system_battery_temperature_enable']:checked").val();	
	maintenanceScheduleEnabled = $("input[name='ags_system_exercise_enable']:checked").val();	
	
	start_voltage = parseInt($('input[name="ags_system_voltage_start_voltage"]').val(), 10);
	voltage_stop =  parseInt($('input[name="ags_system_voltage_stop"]').val(), 10);;
	time_start_hour = parseInt($('input[name="ags_system_time_start_hour"]').val(), 10);
	time_duration_minutes = parseInt($('input[name="ags_system_time_duration_minutes"]').val(), 10);
	start_soc = parseInt($('input[name="ags_system_soc_start_soc"]').val(), 10);
	stop_soc = parseInt($('input[name="ags_system_soc_stop_soc"]').val(), 10);
	start_amps = parseInt($('input[name="ags_system_amps_start_amps"]').val(), 10);
	amps_duration_minutes = parseInt($('input[name="ags_system_amps_duration_minutes"]').val(), 10);
	transformer_temperature_exceeds = parseInt($('input[name="ags_system_transformer_temperature_exceeds"]').val(), 10);
	transformer_duration_minutes = parseInt($('input[name="ags_system_transformer_duration_minutes"]').val(), 10);
	battery_temperature_exceeds = parseInt($('input[name="ags_system_battery_temperature_exceeds"]').val(), 10);
	battery_duration_minutes = parseInt($('input[name="ags_system_battery_duration_minutes"]').val(), 10);
	excercise_days_between_runs = parseInt($('input[name="ags_system_exercise_days_between_runs"]').val(), 10);
	excercise_start_hour = parseInt($('input[name="ags_system_exercise_start_hour"]').val(), 10);
	exercise_duration_minutes = parseInt($('input[name="ags_system_exercise_duration_minutes"]').val(), 10);
	
	//initiate form validation
	$.validity.setup({  scrollTo: true });

	$.validity.start();
	
	//	
	//validation rules
	//
	if(sysVoltageEnabled == 1){
		//must be in format xx.x
		$('input[name="ags_system_voltage_start_voltage"]').require().match(reg, '#{field} must be in the form XX.X');
		//must be in format xx.x
		$('input[name="ags_system_voltage_stop"]').require().match(reg, '#{field} must be in the form XX.X').greaterThan( start_voltage, "must be greater than start voltage");
	}
	if(sysTimeEnabled == 1){
		//must be integer between 0 and 23
		$('input[name="ags_system_time_start_hour"]').require().match("integer").range(0,23);
		//must be integer between 1 and 1399
		$('input[name="ags_system_time_duration_minutes"]').require().match("integer").greaterThan(0, "This field must be between 0 and 1400").lessThan(1400, "This field must be between 0 and 1400");
	}
	if(sysSOCEnabled == 1){
		//must be integer between 1 and 99
		$('input[name="ags_system_soc_start_soc"]').require().match("integer").range(1,99);
		//must be integer between start_soc value and 100
		$('input[name="ags_system_soc_stop_soc"]').require().greaterThan(start_soc, "must be greater than Start SOC").lessThan(100);
	}
	if(sysAmpsEnabled == 1){
		//must be integer between 0 and -400
		$('input[name="ags_system_amps_start_amps"]').require().match(whole, "This field must be an integer").greaterThan(-400, "This field must be between -400 and 0").lessThan(0, "This field must be between -400 and 0");
		//must be integer between 0 and 1400
		$('input[name="ags_system_amps_duration_minutes"]').require().match("integer").greaterThan(0, "This field must be between 0 and 1400").lessThan(1400, "This field must be between 0 and 1400");
	}
	if(transformerTempEnabled == 1){
		//must be integer between 10 and 200
		$('input[name="ags_system_transformer_temperature_exceeds"]').require().match("integer").greaterThan(10, "This field must be between 10 and 200").lessThan(200, "This field must be between 0 and 200");
		//must be integer between 0 and 1400
		$('input[name="ags_system_transformer_duration_minutes"]').require().match("integer").greaterThan(0, "This field must be between 0 and 1400").lessThan(1400, "This field must be between 0 and 1400");
	}
	if(batteryTempEnabled == 1){
		//must be integer between 0 and 200
		$('input[name="ags_system_battery_temperature_exceeds"]').require().match("integer").greaterThan(10, "This field must be between 10 and 200").lessThan(200, "This field must be between 0 and 200");
		//must be integer between 0 and 1400
		$('input[name="ags_system_battery_duration_minutes"]').require().match("integer").greaterThan(0, "This field must be between 0 and 1400").lessThan(1400, "This field must be between 0 and 1400");
	}
	if(maintenanceScheduleEnabled == 1){
		//must be integer between 0 and 30
		$('input[name="ags_system_exercise_days_between_runs"]').require().match("integer").greaterThan(0, "This field must be between 0 and less than or equal to 30").lessThanOrEqualTo(30, "This field must be between 0 and less than or equal to 30");;
		//must be integer between 0 and 23
		$('input[name="ags_system_exercise_start_hour"]').require().match("integer").range(0,23);
		//must be integer between 0 and 1400
		$('input[name="ags_system_exercise_duration_minutes"]').require().match("integer").greaterThan(0, "This field must be between 0 and 1400").lessThan(1400, "This field must be between 0 and 1400");
	}
	//validation result
	var result = $.validity.end();
	console.log(result);
	if(!result.valid){
		//alert("There were "+ result.errors + " errors in the form. Please correct these and try again. ");
	}
	//returns object property that holds success/fail boolean
	return result.valid;	
}
	
$('#update').on('click', function(e) {
	var json = {};
	$('form :input[type=text]').each(function () {
		var $input = $(this);
		json[$input.attr('name')] = $input.val();
	});
	$('form :input[type=radio]:checked').each(function () {
		var $input = $(this);
		json[$input.attr('name')] = $input.val();
	});
	if(validateForms()){
		console.log('validated - posting');
		$.ajax(url + ie_hack, {
			cache: false,
			dataType: 'json',
			method: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(json)
		}).fail(function (XHR, status, error) {
			alert('There was an error updating configuration data!');
		});
	}
});
	
$( document ).ready(function() {
	//loops through checked radio buttons once document is ready and disabled sections based on the radio button value
	$("form input[type='radio']:checked").each(function(){
		var radio = $(this);
		var name = radio.attr('name');
		var value = radio.val();
		toggleSection(name, value);
	});
	
	//handlers for when radios are changed - will disabled sectiosn of form when changed
	$( "input[type='radio']" ).change(function() {
		var radio = $(this);
		var name = radio.attr('name');
		var value = radio.val();
		toggleSection(name, value);		
	});
});	
</script>
</body>

</html>
