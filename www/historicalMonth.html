
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="UTF-8">
		<title>PRO-Verter RMK: Historical Data</title>
	
	<link href="res/css/solar.css" rel="stylesheet" type="text/css" />
	<link rel="icon" type="images/favicon" href="res/images/favicon_s.ico" />
	


</head>
<body style="background-color: #ffffff; margin-top: 0px;">
<div id="wrapper" style="width: 100%; margin-left: auto; margin-right: auto; background-color:#ffffff;">
	

<div>
		<div id = "header" style = "width:100%;">
			
				
			<a href="http://www.solarstik.com/"><img src="res/images/logo_s.png" alt="Solar Stik" style = "text-decoration: none; border: none; outline: none; padding-bottom: 5px; padding-top: 30px; padding-left: 5px;" /></a>
	
			<b style = "padding-left: 20px" >24/7 Support: 800-793-4364 Ext 102</b>
	
			
				
			
		</div>
		<div class="navBarCon">	
			<ul  style="border: none; width:100%; border-spacing: 0px;list-style-type: none;">
			
				
					<li>
						<a  href="/">Current Conditions</a>
					</li>
					<li>
						<a  href="currentSettings.html">Current Settings</a>
					</li>
					<li>
						<a  href="historical.html">Historical Data</a>
					</li>
				
				</ul>
		</div>
				

						
	</div>
	<div style="text-align: center;">
		<h1 id="headline">PRO-Verter RMK: Historical Data</h1>
				<!--Note: This server will be down for scheduled maintenance from 7PM to 9PM CST today.-->

		<br />
	</div>

	

	<script>if (!window.console){ console = {log: function() {}};}//IE doesn't like calls to console if debugger is not open</script>
	<script type="text/javascript" src="res/js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="res/js/excanvas.min.js"></script>


	<script type="text/javascript" src="res/js/jquery.flot.js"></script>
	<script type="text/javascript" src="res/js/jquery.flot.threshold.js"></script>

	<script type="text/javascript" src="res/js/JUMFlot.min.js"></script>
	<script type="text/javascript" src="res/js/jquery.flot.bandwidth.js"></script>
	<script type="text/javascript" src="res/js/jquery.flot.crosshair.js"></script>

	<script type="text/javascript" src="res/js/date.js"></script>
	<script type="text/javascript" src="res/js/magnum.js"></script>
	<script type="text/javascript" src="res/js/jquery.getUrlParam.js"></script>
	<script type="text/javascript" src="res/js/jsonUrls.js"></script>
	<script>

	var tenMinAvg=[];
	var now=0;
	/*
	var root = "http://192.168.10.216:8080/";

	var urlHist = root+"history.json";
	var urlNow = root+"now.json";
	var urlFiles = root+"historyFiles.json";
	var urlSummary = root+"summaryStats.json";
	var urlChannels = root+"channels.json";
	*/
	var isIE = msieversion();
	var loadTimer;
	var calMonths = [0,"January","Feburary","March","April","May","June","July","August","September","October","November","December"];

	$(document).ready(function(){
		/* The bar doesn't like to work on ipods */
		if ( navigator.platform == 'iPhone' || navigator.platform == 'iPod' ) { 
			$("#bar").hide();
		
		};
		

		

		/* window refocus listener  */
		$(window).focus(function() {
			//loadData();
		});

		/* ajax error listener */
		$( document ).ajaxError(function(event){
			$("#connection_warn").show();
			$("#connection_warn").append(event);
			

			//$("#cover").hide();
			//clearInterval(loadTimerVar);
		});
		loadHeadline();
		loadChannels();
		

	});

	/* headline */
	function loadHeadline(){

		// If internet explorer, use Microsoft XDR
		if ( isIE ) {
		    var xdr = new XDomainRequest();
		    xdr.open("get", urlHostname+"?t="+new Date().getTime());
		    xdr.onload = function() {
		       
			dataS = $.parseJSON(xdr.responseText);
			$("#headline").html("PRO-Verter RMK ("+dataS.hostname+"): Historical Data");
			
			
		    };
		    xdr.send();
		} else {
			/* if not IE we use ajax */
		  	$.ajaxSetup({ cache: false });
			$.ajax({
				type: "GET",
				url: urlHostname,
				dataType: "html",
				crossDomain : true
			})
			.done(function( dataS ) {

				dataS = $.parseJSON(dataS);
				$("#headline").html("PRO-Verter RMK ("+dataS.hostname+"): Current Conditions");
				
			});

		}

	}

	/* This script kindly provided by Microsoft */
	function msieversion(){
		var ua = window.navigator.userAgent
		var msie = ua.indexOf ( "MSIE " )

		if ( msie > 0 )      // If Internet Explorer, return version number
			return parseInt (ua.substring (msie+5, ua.indexOf (".", msie )))
		else                 // If another browser, return 0
			return 0

	}

	/* Currently this has no point. It is just holding every object with it's timestamp as the key. */
	var dataAr = [];
	/* used to convert the timestamp into something human readable */
	var date;
	/* oldestTime is used to create the tableTitle */
	var oldestTime;
	var mostRecentTime;
	var chargeAr=[];
	var summaryAr;
	var flot=[];
	var channels;

	function loadChannels(){
	        // If internet explorer, use Microsoft XDR
		if ( isIE ){
		    var xdr = new XDomainRequest();
		    xdr.open("get", urlChannel+"?t="+new Date().getTime());
		    xdr.onload = function() {
			dataS = $.parseJSON(xdr.responseText);
			channels=dataS.data;
			loadSummary()
			
		    };
		    xdr.send();
		} else {
			/* if not IE we use ajax */
		  	$.ajaxSetup({ cache: false });
			$.ajax({
				type: "GET",
				url: urlChannel,
				dataType: "html",
				crossDomain : true
			})
			.done(function( dataS ) {
				dataS = $.parseJSON(dataS);
				channels=dataS.data;
				loadSummary(); 
				
			});

		}

	}

	/* This returns the object that holds the channel data */
	function getChObj(channel){
		for (var i = 0 ; i < channels.length ; i++ ) {
			if ( channels[i].id == channel ) return channels[i];
		}
		return null;
	}
	
	/* Returns array of channels to summarize */
	function getSumChannels(){
		var sumChanAr = [];
		for (var i = 0 ; i < channels.length ; i++ ) {
			if ( channels[i].historyByDay != null && channels[i].historyByDay == "true") {
				sumChanAr.push(channels[i].id);
			}
		}
		return sumChanAr;
	}

	function loadSummary(){
		if ( isIE ){
		    var xdr = new XDomainRequest();
		    xdr.open("get", urlSummary+"?t="+new Date().getTime());
		    xdr.onload = function() {
		       

			if ( "" == xdr.responseText ) {
				$("#files").html("");
				$("#lH1").html("Summary not available at this time. Try again in a couple minutes.");
				$("#loading").show();
				setTimeout(loadSummary,1000*10);
			} else {
				
				dataS = $.parseJSON(xdr.responseText);
				processSum(dataS);
			}

			
		    };
		    xdr.send();
		} else {
			/* if not IE we use ajax */
		  	$.ajaxSetup({ cache: false });
			$.ajax({
				type: "GET",
				url: urlSummary,
				dataType: "html",
				crossDomain : true
			})
			.done(function( dataS ) {
				if ( undefined == dataS ) {
					$("#files").html("");
					$("#lH1").html("Summary not available at this time. Try again in a couple minutes.");
					$("#loading").show();
					setTimeout(loadSummary,1000*10);
				} else {
					dataS = $.parseJSON(dataS);
					processSum(dataS);
				}

				
			});

		}


	}
		
	function processSum(data) {
		
		summaryAr=data.summary_stats;
	
		getFiles();

	}

	function getFiles() {
		if ( isIE ){
		    var xdr = new XDomainRequest();
		    xdr.open("get", urlFiles+"?t="+new Date().getTime());
		    xdr.onload = function() {
		       
			dataS = $.parseJSON(xdr.responseText);
			processFiles(dataS);
			
		    };
		    xdr.send();
		} else {
			/* if not IE we use ajax */
		  	$.ajaxSetup({ cache: false });
			$.ajax({
				type: "GET",
				url: urlFiles,
				dataType: "html",
				crossDomain : true
			})
			.done(function( dataS ) {
				dataS = $.parseJSON(dataS);
				processFiles(dataS);

				
			});

		}
	   
	}

	function processFiles(data) {
		
	
		var fileAr = data.history_files.files;
		var lastYear = "";
		var lastMonth = "";
		var years = [];
		var months = [];
		
		var dispMonths = $(document).getUrlParam("months[]");

		//dispMonths = ["201410","201409","201408","201407"];

		/* sort the files because they may not be in order */
		fileAr.sort();

		//fileAr.sort(function(a, b){return b-a});
		var table = "";
		var txtLink = "";
		var csvLink = "";
		var chanSumAr = getSumChannels();
		var colSpan = (chanSumAr.length*3)+3;
		/* iterate through all file names */


		for ( var i = fileAr.length-1 ; i >= 0  ; i--) {

			var boolAdd;
			/*  */
			if ( isIE ) {
				if ( dispMonths instanceof Array ) {
					boolAdd = (-1 != jQuery.inArray( fileAr[i].substr(0,6), dispMonths ));
				} else {
					boolAdd = (-1 != dispMonths.indexOf( fileAr[i].substr(0,6)));
				}
			} else {
				boolAdd = (-1 != dispMonths.indexOf( fileAr[i].substr(0,6)));
			}
			
			if ( boolAdd ) {
				/* check the year */
				if (!isNaN(fileAr[i].substr(0,4))) {				
					if (lastYear != fileAr[i].substr(0,4)){
						/* set to current year */
						lastYear = fileAr[i].substr(0,4);
						/* add to the year array */
						years.push( fileAr[i].substr(0,4) );

						/* month has to be reset if year is changed incase the same month of different years is selected. */
						lastMonth = 0;
						//$("#files").append("<tr><th colspan=2>"+fileAr[i].substr(0,4)+"</th></tr>");
					}
					/* check the month */
					if (lastMonth != fileAr[i].substr(4,2)){
						/* set to current month */
						lastMonth = fileAr[i].substr(4,2);
						/* add to the month array */
						if ( null == months[lastYear] ) 						
							months[lastYear]=[];	
						months[lastYear].push( fileAr[i].substr(4,2) );
					
						$("#files").append("<tr><th colspan="+colSpan+">"+calMonths[parseInt(fileAr[i].substr(4,2),10)]+" - "+fileAr[i].substr(0,4)+"</th></div></tr>");
						$("#files").append("<tr><td colspan="+colSpan+"><div class=\"histChart\" id=\"chart"+fileAr[i].substr(0,6)+"\" ></div><div style=\"padding-left:15%;padding-right:15%;\" id=\"legend"+fileAr[i].substr(0,6)+"\"></td></tr>");
						var chan = "";
						for ( var j = 0 ; j < chanSumAr.length ; j++ ) {
							var obj = getChObj(chanSumAr[j]);
							chan+="<th colspan=3>"+obj.title+" ("+obj.units+")</th>";
				
						}
						$("#files").append(
							"<tr>"+
								"<th rowspan=2>Date</th>"+
								"<th rowspan=2>nData</th>"+
								chan +
								"<th rowspan=2>Export</th>"+
							"</tr>"
						);
						chan = "";
						for ( var j = 0 ; j < chanSumAr.length ; j++ ) {
							chan+="<th>Min</th><th>Max</th><th>Avg</th>";
				
						}
						$("#files").append(
							"<tr>"+
								chan+
							"</tr>"
						);

						//$("#files").append("<tr><th>"+fileAr[i].substr(4,2)+"</th></tr>");
					}
					/* add file */
				
					$("#files").append(getRow(fileAr[i]));
				}
			} 
		
		}
		//console.log(months);
		/* iterate through years array and add headers */
		/*var table = "";
		for ( var j = 0 ; j < years.length ; j++ ) {
			table+="<tr><th>"+years[j]+"</th></tr>";
				
			for ( var i = 0 ; i < months[years[j]].length ; i++ ) {
				table+="<tr><td><input type=\"checkbox\">"+years[j]+"-"+months[years[j]][i]+"</td></tr>";				
			}
		
	
		}
	
		$("#files").append(table);
		/* iterate through years again with months to add checkboxes */
/*
		table = "<tr>";
	
		$("#files").append(table);*/
		plotCharts();
		$("#loading").hide();
	
	}
	
	function getRow(filename){
		//console.log(filename);
		var chanSumAr = getSumChannels();
		var line = "<tr><td style=\"text-align: center;\">";
		txtLink = root+"history/"+filename.substr(0,8)+".txt";
		csvLink = root+"history/"+filename.substr(0,8)+".csv";
		date = filename.substr(0,4)+"-"+filename.substr(4,2)+"-"+filename.substr(6,2);
		line+=date+"</td>";
		var lineAr;
		for ( var i = 0 ; i < summaryAr.length ; i++ ) {
			if ( -1 != filename.indexOf(summaryAr[i].day) ){
				lineAr=	summaryAr[i];
				break;
			}
		}
		//console.log(lineAr);
		/* n */
		line+="<td>"+Math.round(lineAr.n)+"</td>"
		/* channels */
		
		for ( var j = 0 ; j < chanSumAr.length ; j++ ) {
			var lineMin;
			var lineMax;
			var lineAvg;
			var prec = getChObj(chanSumAr[j]).precision;
			if ( null == prec ) prec = 0;
			lineAr.prec = prec;
			for (key in lineAr){
				if ( -1 != key.indexOf(chanSumAr[j]) && -1 != key.indexOf("min") ) lineMin = parseFloat(lineAr[key]).toFixed(prec);
				if ( -1 != key.indexOf(chanSumAr[j]) && -1 != key.indexOf("max") ) lineMax = parseFloat(lineAr[key]).toFixed(prec);
				if ( -1 != key.indexOf(chanSumAr[j]) && -1 != key.indexOf("avg") ) lineAvg = parseFloat(lineAr[key]).toFixed(prec);
			}
			
			line+="<td>"+lineMin+"</td><td>"+lineMax+"</td><td>"+lineAvg+"</td>";
	
		}
		/* b_state_of_charge */
		//line+="<td>"+lineAr.b_state_of_charge_min+"</td><td>"+lineAr.b_state_of_charge_max+"</td><td>"+Math.round(lineAr.b_state_of_charge_avg)+"</td>";

		/* i_dc_volts */
		//line+="<td>"+lineAr.i_dc_volts_min+"</td><td>"+lineAr.i_dc_volts_min+"</td><td>"+lineAr.i_dc_volts_min+"</td>";

		/* i_temp_battery */
		//line+="<td>"+lineAr.i_temp_battery_min+"</td><td>"+lineAr.i_temp_battery_min+"</td><td>"+lineAr.i_temp_battery_min+"</td>";

		line+="<td style=\"text-align: center;\">Raw Data: (<a href=\""+txtLink+"\" target=\"_blank\" >TXT</a>) (<a href=\""+csvLink+"\" target=\"_blank\" >CSV</a>)</td></tr>";

		yearMonth = (lineAr.day+"").substr(0,6);
		day = (lineAr.day+"").substr(6,2);

			/* 
			flot[yearMonth][0] soc avg
			flot[yearMonth][1] soc bands
			flot[yearMonth][2] temp avg
			flot[yearMonth][3] temp bands

			var socArray = [[30,73.7],[29,86.2],...];
			var socBands = [[30,70,78],[29,78,94],...];
			var tempArray = [[30,15.0],[29,15.0],...];
			var tempBands = [[30,15,15],[29,15,15],...];
			 */
		/*  */
		if ( null == flot[yearMonth] ) {

			flot[yearMonth]=[[],[],[],[]];
			flot[yearMonth][0].unshift([day, parseFloat(lineAr.b_state_of_charge_avg).toFixed(lineAr.prec)]);
			flot[yearMonth][1].unshift([day, parseFloat(lineAr.b_state_of_charge_min).toFixed(lineAr.prec),parseFloat(lineAr.b_state_of_charge_max).toFixed(lineAr.prec)]);
			flot[yearMonth][2].unshift([day, parseFloat(lineAr.i_temp_battery_avg).toFixed(lineAr.prec)]);
			flot[yearMonth][3].unshift([day, parseFloat(lineAr.i_temp_battery_min).toFixed(lineAr.prec),parseFloat(lineAr.i_temp_battery_max).toFixed(lineAr.prec)]);
			
	
		} else {
			flot[yearMonth][0].unshift([ day, parseFloat(lineAr.b_state_of_charge_avg).toFixed(lineAr.prec) ]);
			flot[yearMonth][1].unshift([ day, parseFloat(lineAr.b_state_of_charge_min).toFixed(lineAr.prec), parseFloat(lineAr.b_state_of_charge_max).toFixed(lineAr.prec) ]);
			flot[yearMonth][2].unshift([ day, parseFloat(lineAr.i_temp_battery_avg).toFixed(lineAr.prec) ]);
			flot[yearMonth][3].unshift([ day, parseFloat(lineAr.i_temp_battery_min).toFixed(lineAr.prec), parseFloat(lineAr.i_temp_battery_max).toFixed(lineAr.prec) ]);
		}
		return line;
	}

	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for(var i=0; i<ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0)==' ') c = c.substring(1);
			if (c.indexOf(name) != -1) return c.substring(name.length,c.length);
		}
		return "";
	}

	function hideWarn(){
		$("#connection_warn").hide();
	}
	var data0 = [];
	var plot0 = [];
	function plotCharts(){
		/* tool tip */
		$("<div id='tooltip'></div>").css({
			position: "absolute",
			display: "none",
			border: "1px solid #fdd",
			padding: "2px",
			"background-color": "#fee",
			opacity: 0.80
		}).appendTo("body");
		/* get each key in array of flot. Each key is actually the yearMonth ex. 201410 */
		for (key in flot) {
			if (flot.hasOwnProperty(key)  &&        // These are explained
				/^0$|^[1-9]\d*$/.test(key) &&    // and then hidden
				key <= 4294967294                // away below
			) {
				//console.log("Plot: "+key);

				data0[key] = [{

					data: flot[key][0],
					label: "Average SOC",
					lines: {
						show: true,
						lineWidth: 3
					}, 
					color: "blue"
				},{

					data: flot[key][1],
					label: "SOC Min/Max",
					bandwidth: {
						show: true,
						lineWidth: 0
					},
					color: "red"
				}, {
					data: flot[key][2],
					label: "Temperature",
					lines: {
						show: true,
						lineWidth: 3
					}, 
					color: "orange"
				},{

					data: flot[key][3],
					label: "Temperature Min/Max",
					bandwidth: {
						show: true,
						lineWidth: 0
					},
					color: "red"
				} ];

					var optionsEdit = {
						series: {
							shadowSize: 0,
							bandwidth: {
								active: true,
								lineWidth: 0
							},
							lines: {
								show: true
							}
						},
						crosshair: {
							mode: "x"
						},
						grid: {
							hoverable: true,
							autoHighlight: false
						}, 
						xaxes: [{
							min: flot[key][0][0][0],
							max: flot[key][0][flot[key][0].length-1][0],//30,
							ticks: flot[key][0].length-1
						}],
						yaxis: {
							//min: 0,
							max: 100
						}, 
						legend: {
							show: true,
							position: "se",
							noColumns : 4,
							backgroundOpacity: 0.1,
							container: $('#legend'+key)
							//margin: [0, -70]
						}
					};

				if ( flot[key][0].length>0 ) {
					plot0[key] = $.plot("#chart"+key, data0[key],optionsEdit);

					$("#chart"+key).bind("plothover", createPlotHoverHandler(plot0[key]));


				}else{

					$("#chart"+key).html("<h1>Not Enough Data </h1>");

				}
	



			}
		}


		
	}
	// Returns a function that can be used as the plothover event handler
	function createPlotHoverHandler(plot) {
		// This is the actual handler, it has access to the plot closure variable
		return function(e, pos, item)  {

			var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";

			$("#hoverdata").text(str);
			key = plot.getPlaceholder().selector.substr(6);
			if (item) {
				var x = item.datapoint[0].toFixed(0), y = item.datapoint[1].toFixed(2);

				/* temperature or SOC: 3 is temperature and 1 is SOC */
				var tOrS = 3;
				var units = "C";

				if ( "SOC" == item.series.label ) {
					tOrS = 1;
					units = "%";
				}
				//console.log(x);
				var day = 0;
				var found = false;
				for ( var i = 0 ; i < flot[key][tOrS].length ; i++ ) {
					if ( parseInt(x) == parseInt(flot[key][tOrS][i][0]) ) {
						//console.log( i );
						found = true;
						day = i;
						
					}
				}
				if ( found ) {
					$("#tooltip").html(item.series.label + " on " + key.substr(0,4) + "-" + key.substr(4,2) + "-" + ("0"+x).slice(-2) + "<br>"+
							"Min = " + flot[key] [tOrS]   [day] [1] + units + "<br>" +
							"Max = " + flot[key] [tOrS]   [day] [2] + units + "<br>" +
							"Avg = " + flot[key] [tOrS-1] [day] [1] + units
						)
						.css({top: item.pageY+5, left: item.pageX+5})
						.fadeIn(200);
				} else {
				}
				
			} else {
				$("#tooltip").hide();
			}
		}
	}
	</script>

	

	<div id="loading" style="text-align: center;">
		<h1 id="lH1">Loading...</h1>
	</div>


	<div class="caution" style="display: none;" >
		<p>
		This station is marked as supplying live data, however the data appears to be old. Please check the age of the data carefully before using it!
		</p>
	</div>

	<div id="connection_warn" style="text-align: center; width: 800px; margin-right: auto; margin-left: auto; background-color: orange; color: white; display: none;" onclick="hideWarn()">
			<h1>No Response From Server. Please check to make sure you are still connected to the internet</h1>
	</div>
	
	
	<h4 style="text-align: center;"><a href="table.html" target="_blank">Fault and Status Code Reference</a></h4>
	<table style="margin-left:auto; margin-right: auto;" id="files"></table>
<br>
<br>
	<div style="text-align:center; padding-bottom: 50px;">

	</div>
</div>

</body>
</html>
